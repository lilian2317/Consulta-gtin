<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Consulta de Produtos</title>
  <link rel="manifest" href="/manifest.json">

  <style>
    body { font-family: system-ui, -apple-system, BlinkMacSystemFont; background:#0b0b0b; color:#fff; margin:0; }
    header { padding:20px; font-size:26px; font-weight:900; text-align:center; }

    .wrap { padding:16px; display:grid; gap:14px; max-width:720px; margin:0 auto; }

    button, input { font-size:22px; padding:16px; border-radius:16px; border:0; width:100%; }
    button { font-weight:900; background:#2f7cff; color:#fff; }
    button.update { background:#22c55e; color:#000; }

    input { background:#fff; color:#000; }

    .hint { font-size:20px; opacity:.9; line-height:1.3; text-align:center; }

    .card { background:#151515; border-radius:18px; padding:18px; }
    .product-name { font-size:26px; font-weight:900; margin-bottom:8px; }
    .price { font-size:24px; font-weight:900; margin-bottom:10px; }
    .price span { background:#ffe45c; color:#111; padding:6px 12px; border-radius:12px; }

    .warn {
      margin-top:10px;
      padding:12px;
      border-radius:12px;
      background:#2a1b1b;
      border:1px solid #5a2a2a;
      font-size:18px;
      line-height:1.3;
    }

    img { width:100%; max-height:320px; object-fit:contain; border-radius:14px; margin-top:12px; background:#0b0b0b; }

    hr { border:0; border-top:1px solid #2a2a2a; margin:14px 0; }

    /* ‚úÖ Alerta verde visual */
    .okBanner {
      display:none;
      text-align:center;
      font-size:20px;
      font-weight:900;
      padding:12px;
      border-radius:14px;
      background:#22c55e;
      color:#071a0a;
    }
    .okBanner.show { display:block; }

    /* v√≠deo do scanner */
    #scanVideo {
      width:100%;
      border-radius:18px;
      margin-top:10px;
      background:#000;
    }
  </style>
</head>

<body>
<header>Consulta de Produtos</header>

<div class="wrap">

  <button onclick="scan()">üì∑ Escanear c√≥digo de barras</button>

  <div class="hint">
    Se a c√¢mera desfocar, <b>afaste o celular</b> at√© o c√≥digo ficar bem n√≠tido.
  </div>

  <input id="q" placeholder="Digite o GTIN ou o nome do produto">

  <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
    <button onclick="buscar()">üîç Buscar</button>
    <button class="update" onclick="atualizar()">üîÑ Atualizar</button>
  </div>

  <div id="ok" class="okBanner">‚úÖ C√ìDIGO LIDO!</div>

  <div class="card" id="res">Aguardando‚Ä¶</div>

</div>

<script src="https://unpkg.com/@zxing/library@latest"></script>
<script>
let reader = null;
let lastQuery = "";
let scanning = false;

let videoEl = null;  // refer√™ncia do v√≠deo atual

function beep(){
  try{
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const o = ctx.createOscillator();
    o.frequency.value = 880;
    o.connect(ctx.destination);
    o.start();
    setTimeout(() => o.stop(), 80);
  }catch(e){}
}

function flashGreen(){
  const ok = document.getElementById("ok");
  ok.classList.add("show");
  setTimeout(() => ok.classList.remove("show"), 800);
}

function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, m =>
    ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m])
  );
}

function isZeroOrEmpty(v){
  if (v === null || v === undefined) return true;
  if (typeof v === "number") return v === 0;
  const t = String(v).trim();
  if (!t) return true;
  // aceita "0", "0,00", "0.00", "R$ 0", etc.
  const digits = t.replace(/[^\d.,-]/g, "");
  return digits === "0" || digits === "0,0" || digits === "0,00" || digits === "0.0" || digits === "0.00";
}

function formatPrice(v){
  if(v === null || v === undefined || v === "") return "‚Äî";
  if(typeof v === "number"){
    return v.toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
  }
  return String(v).includes("R$") ? v : ("R$ " + v);
}

function stopScan(){
  try { reader?.reset?.(); } catch(e) {}
  if (videoEl) {
    try { videoEl.srcObject && videoEl.srcObject.getTracks().forEach(t => t.stop()); } catch(e) {}
    try { videoEl.remove(); } catch(e) {}
  }
  videoEl = null;
  scanning = false;
}

function renderItems(items){
  const res = document.getElementById("res");
  if(!items || !items.length){
    res.textContent = "Produto n√£o encontrado";
    return;
  }

  res.innerHTML = items.map(p => {
    const needPriceWarn = isZeroOrEmpty(p.preco);

    return `
      <div>
        <div class="product-name">${escapeHtml(p.name)}</div>

        <div class="price">
          Pre√ßo: <span>${escapeHtml(formatPrice(p.preco))}</span>
        </div>

        ${needPriceWarn ? `<div class="warn"><b>Pre√ßo ainda n√£o definido.</b> Tomar provid√™ncias.</div>` : ""}

        ${p.gtin ? `<div class="hint">GTIN: ${escapeHtml(p.gtin)}</div>` : ""}
        ${p.img ? `<img src="${p.img}" alt="Imagem do produto">` : ""}
      </div>
    `;
  }).join('<hr>');
}

async function buscar(forced){
  // ‚úÖ Se eu buscar digitando, fecha a c√¢mera automaticamente
  stopScan();

  const q = (forced || document.getElementById("q").value).trim();
  if(!q){
    document.getElementById("res").textContent = "Digite um GTIN ou nome.";
    return;
  }

  lastQuery = q;
  document.getElementById("res").textContent = "Buscando no Notion‚Ä¶";

  const r = await fetch(`/api/lookup?q=${encodeURIComponent(q)}`);
  const d = await r.json().catch(()=>({}));

  if(!r.ok || !d.found){
    document.getElementById("res").textContent = "Produto n√£o encontrado";
    return;
  }

  renderItems(d.items);
}

function atualizar(){
  // ‚úÖ Atualizar tamb√©m fecha a c√¢mera
  stopScan();

  if(!lastQuery){
    document.getElementById("res").textContent = "Busque ou escaneie um produto primeiro.";
    return;
  }
  buscar(lastQuery);
}

async function scan(){
  if(scanning) return;
  scanning = true;

  // se j√° tinha algum scan anterior, encerra
  stopScan();
  scanning = true;

  const resBox = document.getElementById("res");
  resBox.innerHTML = `
    <div class="hint">
      Aponte para o c√≥digo.<br>
      Se desfocar, <b>afaste o celular</b>.
    </div>
  `;

  // cria o v√≠deo e guarda refer√™ncia
  videoEl = document.createElement("video");
  videoEl.id = "scanVideo";
  videoEl.setAttribute("playsinline","true");
  document.querySelector(".wrap").insertBefore(videoEl, resBox);

  // ‚úÖ Formatos GTIN mais comuns
  const hints = new Map();
  hints.set(ZXing.DecodeHintType.POSSIBLE_FORMATS,[
    ZXing.BarcodeFormat.EAN_13,
    ZXing.BarcodeFormat.EAN_8,
    ZXing.BarcodeFormat.UPC_A
  ]);

  reader = new ZXing.BrowserMultiFormatReader(hints);

  try{
    // ‚úÖ iPhone: n√£o escolher deviceId (mais est√°vel)
    reader.decodeFromVideoDevice(null, videoEl, (result) => {
      if(result){
        const code = result.getText().trim();

        stopScan();
        beep();
        flashGreen();

        document.getElementById("q").value = code;
        buscar(code);
      }
    });
  }catch(e){
    stopScan();
    resBox.textContent = "N√£o foi poss√≠vel acessar a c√¢mera. Feche e abra o app.";
  }
}
</script>

</body>
</html>