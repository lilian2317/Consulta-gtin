<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Consulta de Produtos</title>
  <link rel="manifest" href="/manifest.json">

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont;
      background:#0b0b0b;
      color:#ffffff;
      margin:0;
    }

    header {
      padding:20px;
      font-size:26px;
      font-weight:900;
      text-align:center;
    }

    .wrap {
      padding:16px;
      display:grid;
      gap:14px;
      max-width:720px;
      margin:0 auto;
    }

    button, input {
      font-size:22px;
      padding:16px;
      border-radius:16px;
      border:0;
      width:100%;
    }

    button {
      font-weight:900;
      background:#2f7cff;
      color:#fff;
    }

    button.secondary {
      background:#3a3a3a;
    }

    button.update {
      background:#22c55e;
      color:#000;
    }

    input {
      background:#ffffff;
      color:#000;
    }

    .hint {
      font-size:20px;
      opacity:0.9;
      line-height:1.3;
      text-align:center;
    }

    .card {
      background:#151515;
      border-radius:18px;
      padding:18px;
    }

    .product-name {
      font-size:26px;
      font-weight:900;
      margin-bottom:8px;
    }

    .price {
      font-size:24px;
      font-weight:900;
      margin-bottom:12px;
    }

    .price span {
      background:#ffe45c;
      color:#111;
      padding:6px 12px;
      border-radius:12px;
    }

    img {
      width:100%;
      max-height:320px;
      object-fit:contain;
      border-radius:14px;
      margin-top:12px;
      background:#0b0b0b;
    }

    hr {
      border:0;
      border-top:1px solid #2a2a2a;
      margin:14px 0;
    }
  </style>
</head>

<body>

<header>Consulta de Produtos</header>

<div class="wrap">

  <button onclick="scan()">üì∑ Escanear c√≥digo de barras</button>

  <div class="hint">
    Se a c√¢mera desfocar, <b>afaste o celular</b> at√© o c√≥digo ficar bem n√≠tido.
  </div>

  <button class="secondary" onclick="scan()">üîÑ Tentar de novo</button>

  <input id="q" placeholder="Digite o GTIN ou o nome do produto">

  <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
    <button onclick="buscar()">üîç Buscar</button>
    <button class="update" onclick="atualizar()">üîÑ Atualizar</button>
  </div>

  <div class="card" id="res">Aguardando‚Ä¶</div>

</div>

<script src="https://unpkg.com/@zxing/library@latest"></script>
<script>
let reader;
let lastQuery = "";
let scanning = false;

/* üîî bip simples (compat√≠vel com iPhone) */
function beep(){
  try{
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const o = ctx.createOscillator();
    o.frequency.value = 880;
    o.connect(ctx.destination);
    o.start();
    setTimeout(() => o.stop(), 80);
  }catch(e){}
}

function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, m =>
    ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m])
  );
}

function formatPrice(v){
  if(v === null || v === undefined || v === "") return "‚Äî";
  if(typeof v === "number"){
    return v.toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
  }
  return String(v).includes("R$") ? v : ("R$ " + v);
}

function renderItems(items){
  const res = document.getElementById("res");
  if(!items || !items.length){
    res.textContent = "Produto n√£o encontrado";
    return;
  }

  res.innerHTML = items.map(p => `
    <div>
      <div class="product-name">${escapeHtml(p.name)}</div>
      <div class="price">
        Pre√ßo: <span>${escapeHtml(formatPrice(p.preco))}</span>
      </div>
      ${p.gtin ? `<div class="hint">GTIN: ${escapeHtml(p.gtin)}</div>` : ""}
      ${p.img ? `<img src="${p.img}" alt="Imagem do produto">` : ""}
    </div>
  `).join('<hr>');
}

async function buscar(forced){
  const q = (forced || document.getElementById("q").value).trim();
  if(!q){
    document.getElementById("res").textContent = "Digite um GTIN ou nome.";
    return;
  }

  lastQuery = q;
  document.getElementById("res").textContent = "Buscando no Notion‚Ä¶";

  const r = await fetch(`/api/lookup?q=${encodeURIComponent(q)}`);
  const d = await r.json().catch(()=>({}));

  if(!r.ok || !d.found){
    document.getElementById("res").textContent = "Produto n√£o encontrado";
    return;
  }

  renderItems(d.items);
}

function atualizar(){
  if(!lastQuery){
    document.getElementById("res").textContent =
      "Busque ou escaneie um produto primeiro.";
    return;
  }
  buscar(lastQuery);
}

async function scan(){
  if(scanning) return;
  scanning = true;

  const resBox = document.getElementById("res");
  resBox.innerHTML = `
    <div class="hint">
      Aponte para o c√≥digo.<br>
      Se desfocar, <b>afaste o celular</b>.
    </div>
  `;

  try{ reader?.reset?.(); }catch(e){}

  const video = document.createElement("video");
  video.setAttribute("playsinline","true");
  video.style.width="100%";
  video.style.borderRadius="18px";
  video.style.marginTop="10px";
  document.querySelector(".wrap").insertBefore(video,resBox);

  const hints = new Map();
  hints.set(ZXing.DecodeHintType.POSSIBLE_FORMATS,[
    ZXing.BarcodeFormat.EAN_13,
    ZXing.BarcodeFormat.EAN_8,
    ZXing.BarcodeFormat.UPC_A
  ]);

  reader = new ZXing.BrowserMultiFormatReader(hints);

  try{
    reader.decodeFromVideoDevice(null,video,(result)=>{
      if(result){
        const code = result.getText().trim();
        reader.reset();
        video.remove();
        scanning = false;
        beep();
        document.getElementById("q").value = code;
        buscar(code);
      }
    });
  }catch(e){
    video.remove();
    scanning = false;
    resBox.textContent =
      "N√£o foi poss√≠vel acessar a c√¢mera. Feche e abra o app.";
  }
}
</script>

</body>
</html>